<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>MC Kernel by seismology</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>MC Kernel</h1>
        <p>Calculate seismic sensitivity kernels using Axisem</p>

        <p class="view"><a href="https://github.com/seismology/mc_kernel">View the Project on GitHub <small>seismology/mc_kernel</small></a></p>


        <ul>
          <li><a href="https://github.com/seismology/mc_kernel/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/seismology/mc_kernel/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/seismology/mc_kernel">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="mc-kernel" class="anchor" href="#mc-kernel" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MC Kernel</h1>

<p><a href="https://zenodo.org/badge/latestdoi/21468/seismology/mc_kernel"><img src="https://zenodo.org/badge/21468/seismology/mc_kernel.svg" alt="DOI"></a>
<img src="https://www.geophysik.uni-muenchen.de/%7Estaehler/kerner/logo.png" alt=""></p>

<h3>
<a id="authors" class="anchor" href="#authors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authors:</h3>

<p>Simon Stähler, Martin van Driel, Ludwig Auer, Kasra Hosseini, Tarje Nissen-Meyer</p>

<h3>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>License:</h3>

<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, version 3 of the License.</p>

<h3>
<a id="acknowledgements" class="anchor" href="#acknowledgements" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Acknowledgements:</h3>

<p>If you use this program for your work, please cite:</p>

<p>Simon C. Stähler, Martin van Driel, Ludwig Auer, Kasra Hosseini, Karin Sigloch, and Tarje Nissen-Meyer: <strong>MC Kernel: Broadband Waveform Sensitivity Kernels for Seismic Tomography</strong>, <em>Geophysical Research Abstracts</em>, Vol. 18, EGU2016-7020-2, 2016</p>

<h3>
<a id="download" class="anchor" href="#download" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Download</h3>

<p>To download the current developer version, use git clone</p>

<pre><code>git clone https://github.com/seismology/mc_kernel
</code></pre>

<h2>
<a id="prequisites" class="anchor" href="#prequisites" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Prequisites</h2>

<p>MC Kernel needs a recent Fortran compiler (gfortran 4.8 or later), an MPI installation, the NetCDF library for accessing the wavefield files, the FFTW library for Fourier transforms and LAPACK, because we were too lazy to write a matrix inversion routine ourselves. The installation of these libraries can be done by hand on desktop machines or using modules on HPC environments.
The recommended submit script uses Python and needs NetCDF4</p>

<h4>
<a id="ubuntudebian-linux" class="anchor" href="#ubuntudebian-linux" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Ubuntu/Debian Linux</h4>

<p>Since Ubuntu 14.04LTS, the system libraries can be used:</p>

<div class="highlight highlight-source-shell"><pre>sudo apt-get install gfortran libnetcdff5 libfftw3-dev libblas3 openmpi-bin gfortran python python-netcdf</pre></div>

<h4>
<a id="macos-x" class="anchor" href="#macos-x" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MacOS X</h4>

<p>We recommend using Homebrew to download and compile the necessary libraries. Be careful to add the <em>--with-fortran</em> argument while installing any library. Otherwise, only C libraries are installed. If you did install the libraries before without the <em>--with-fortran</em> argument, it may be necessary to remove and reinstall them.</p>

<h4>
<a id="hpc-environments" class="anchor" href="#hpc-environments" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>HPC environments</h4>

<p>Be sure to load modules for Fortran, NetCDF, FFTW and LAPACK.
On SuperMUC, the necessary commands are</p>

<pre><code>module load fortran
module load netcdf/mpi
module load fftw
module load mkl
</code></pre>

<h2>
<a id="axisem-wavefields" class="anchor" href="#axisem-wavefields" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>AxiSEM wavefields</h2>

<p>Using the code requires computation of a global seismic wavefield using AxiSEM. Please refer to the AxiSEM documentation on how to do this. An set of example wavefields with a dominant period of 40s can be downloaded:</p>

<pre><code>wget https://www.geophysik.uni-muenchen.de/~staehler/kerner_wavefields.tar.bz2
tar -xvf kerner_wavefields.tar.bz2
</code></pre>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h2>

<p>Change into the download directory and copy the included template files into the main directory</p>

<div class="highlight highlight-source-shell"><pre><span class="pl-c1">cd</span> kerner
./copy_templates.sh</pre></div>

<p>The file <em>make_mc_kerner.macros</em> allows you to modify the compiler name and compiler flags according to your system. To compile, use</p>

<div class="highlight highlight-source-shell"><pre>make </pre></div>

<p>and afterwards </p>

<div class="highlight highlight-source-shell"><pre>make check</pre></div>

<p>to run a set of tests (wavefields downloaded in the previous step are necessary for the tests to complete).</p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<p>To run the code, a convenient submit script is available:</p>

<div class="highlight highlight-source-shell"><pre>python submit.py -n NSLAVES JOB_NAME</pre></div>

<p>This creates a run directory <em>JOB_NAME</em>, puts the default input files there and starts a MPI job with one master and NSLAVES worker tasks. In this simple form, it uses default values stored in the files <em>CMTSOLUTION</em>, <em>receivers.dat</em>, <em>filters.dat</em> and <em>stf_20s.dat</em> together with AxiSEM wavefields in ./wavefield/fwd and ./wavefield/bwd.<br>
Modifying the settings for the run is possible by setting one of the options of submit.py, which can be queried by</p>

<div class="highlight highlight-source-shell"><pre>python submit.py -h</pre></div>

<h2>
<a id="plot-results" class="anchor" href="#plot-results" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Plot results</h2>

<p>MC Kerner comes with a set of simple Python plotting scripts to visualize kernels and the seismograms they are based on. They can be found in the folder <strong>pyfiles</strong> and need a few extra programs to run:</p>

<ul>
<li>Paraview (version &gt;= 4.3)</li>
<li>Python packages matplotlib and wand</li>
</ul>

<p>To run the scripts change into the job directory</p>

<div class="highlight highlight-source-shell"><pre><span class="pl-c1">cd</span> JOB_DIR</pre></div>

<p>and run</p>

<div class="highlight highlight-source-shell"><pre>python ../pyfiles/plot_all_seismograms.py
pvpython ../pyfiles/plot_all_kernels.py
python ../pyfiles/create_composites.py</pre></div>

<p>The last script creates a composite image like the one below:
<img src="https://www.geophysik.uni-muenchen.de/%7Estaehler/kerner/composite_plot.png" alt=""></p>

<h2>
<a id="faqs" class="anchor" href="#faqs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>FAQs</h2>

<h3>
<a id="anaconda-interference" class="anchor" href="#anaconda-interference" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Anaconda interference</h3>

<p>The python package manager Anaconda installs his own version of gfortran, which interferes with the system version and the MPI libraries. 
A solution is to replace the compiler name <em>FC</em> and the <em>MPIRUN</em> variable in <em>make_mc_kerner.macros</em> with absolute paths</p>

<div class="highlight highlight-source-shell"><pre>FC = /usr/bin/mpif90</pre></div>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/seismology">seismology</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-67089227-2");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
